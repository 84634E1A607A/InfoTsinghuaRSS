<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Token Manager - Info Tsinghua RSS</title>
</head>
<body>
    <h1>Authentication Token Manager</h1>

    <div id="auth-required">
        <p>You need to authenticate to manage your tokens.</p>
        <p><a href="/auth/login">Login with GitLab</a></p>
    </div>

    <div id="token-manager" style="display: none;">
        <h2>Your API Token</h2>
        <div id="user-info"></div>

        <div id="token-display" style="display: none;">
            <h3>Current Token</h3>
            <p><strong>Save this token!</strong> You'll need it to access the RSS feed.</p>
            <input type="text" id="user-token" readonly style="width: 400px;">
            <button onclick="copyToken()">Copy</button>

            <h4>Actions</h4>
            <button onclick="rotateCurrentToken()">Rotate Token</button>
            <p><small>Rotating will invalidate the current token and create a new one.</small></p>
        </div>

        <div id="no-token" style="display: none;">
            <p>No token found. Please contact support.</p>
        </div>

        <h3>RSS Feed URL</h3>
        <p>Use your token to access the RSS feed:</p>
        <input type="text" id="feed-url" readonly style="width: 500px;">
        <button onclick="copyFeedUrl()">Copy</button>

        <h3>Usage Instructions</h3>
        <ul>
            <li><strong>Header method:</strong> <code>X-API-Token: your-token</code></li>
            <li><strong>Bearer method:</strong> <code>Authorization: Bearer your-token</code></li>
            <li><strong>Query parameter:</strong> <code>?token=your-token</code></li>
        </ul>

        <p><a id="rss-link" href="/rss">View RSS Feed</a></p>
        <p><a href="/docs">API Documentation</a></p>
    </div>

    <div id="error-message" style="display: none; color: red;"></div>

    <script>
        const API_BASE = window.location.origin;
        let currentToken = null;

        // Check authentication on load
        async function checkAuth() {
            try {
                // Get token from URL if present (from OAuth callback), otherwise from localStorage
                currentToken = getTokenFromUrl();
                const isNewToken = getQueryParam('new') === 'true';

                // If token in URL, save it to localStorage
                if (currentToken && isNewToken) {
                    localStorage.setItem('rss_token', currentToken);
                    // Clear URL parameters
                    window.history.replaceState({}, document.title, window.location.pathname);
                } else if (!currentToken) {
                    // Try to get from localStorage
                    currentToken = localStorage.getItem('rss_token');
                }

                // Include token in API status check
                const statusUrl = currentToken ? `${API_BASE}/api/status?token=${encodeURIComponent(currentToken)}` : `${API_BASE}/api/status`;
                const response = await fetch(statusUrl);
                const data = await response.json();

                if (data.authenticated && data.user) {
                    document.getElementById('auth-required').style.display = 'none';
                    document.getElementById('token-manager').style.display = 'block';
                    document.getElementById('user-info').innerHTML =
                        `<p>Logged in as: <strong>${escapeHtml(data.user.username)}</strong> (${escapeHtml(data.user.email)})</p>`;

                    loadToken();
                } else {
                    document.getElementById('auth-required').style.display = 'block';
                    document.getElementById('token-manager').style.display = 'none';
                    // Clear invalid token from localStorage
                    localStorage.removeItem('rss_token');
                }
            } catch (error) {
                showError('Failed to check authentication status: ' + error.message);
            }
        }

        // Load the user's single token
        async function loadToken() {
            try {
                const headers = currentToken ? { 'X-API-Token': currentToken } : {};
                const queryParams = currentToken ? `?token=${encodeURIComponent(currentToken)}` : '';

                const response = await fetch(`${API_BASE}/auth/tokens${queryParams}`, { headers });
                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/auth/login';
                        return;
                    }
                    throw new Error('Failed to load token');
                }

                const tokens = await response.json();

                if (tokens.length > 0) {
                    // Display the first (and should be only) token
                    // Token is already set from currentToken variable
                    document.getElementById('user-token').value = currentToken || 'YOUR_TOKEN_HERE';
                    document.getElementById('token-display').style.display = 'block';
                    document.getElementById('no-token').style.display = 'none';

                    // Update feed URL and RSS link
                    const feedUrl = `${API_BASE}/rss?token=${encodeURIComponent(currentToken || 'YOUR_TOKEN')}`;
                    document.getElementById('feed-url').value = feedUrl;
                    document.getElementById('rss-link').href = feedUrl;
                } else {
                    document.getElementById('token-display').style.display = 'none';
                    document.getElementById('no-token').style.display = 'block';
                }
            } catch (error) {
                showError('Failed to load token: ' + error.message);
            }
        }

        // Rotate current token
        async function rotateCurrentToken() {
            if (!currentToken) {
                showError('No token to rotate');
                return;
            }

            if (!confirm('This will invalidate your current token and create a new one. Continue?')) {
                return;
            }

            try {
                const headers = currentToken ? { 'X-API-Token': currentToken } : {};
                const queryParams = currentToken ? `?token=${encodeURIComponent(currentToken)}` : '';

                const response = await fetch(`${API_BASE}/auth/tokens/${encodeURIComponent(currentToken)}/rotate${queryParams}`, {
                    method: 'POST',
                    headers: headers
                });

                if (!response.ok) {
                    throw new Error('Failed to rotate token');
                }

                const data = await response.json();

                // Update current token and save to localStorage
                currentToken = data.token;
                localStorage.setItem('rss_token', currentToken);

                // Update display
                const feedUrl = `${API_BASE}/rss?token=${encodeURIComponent(currentToken)}`;
                document.getElementById('user-token').value = currentToken;
                document.getElementById('feed-url').value = feedUrl;
                document.getElementById('rss-link').href = feedUrl;

                alert('Token rotated successfully! Your new token is: ' + currentToken);
            } catch (error) {
                showError('Failed to rotate token: ' + error.message);
            }
        }

        // Copy token to clipboard
        function copyToken() {
            const tokenField = document.getElementById('user-token');
            tokenField.select();
            document.execCommand('copy');
            alert('Token copied to clipboard!');
        }

        // Copy feed URL to clipboard
        function copyFeedUrl() {
            const feedUrlField = document.getElementById('feed-url');
            feedUrlField.select();
            document.execCommand('copy');
            alert('Feed URL copied to clipboard!');
        }

        // Get token from URL query parameter
        function getTokenFromUrl() {
            return getQueryParam('token');
        }

        // Get query parameter
        function getQueryParam(name) {
            const params = new URLSearchParams(window.location.search);
            return params.get(name);
        }

        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize
        checkAuth();
    </script>
</body>
</html>
